<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تحلیلگر داده‌های فیوچرز کریپتو - ورودی متنی</title>
    <style>
        body {
            font-family: Tahoma, sans-serif;
            background-color: #1e1e2f;
            color: #e0e0e0;
            padding: 10px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: #2a2a47;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        h1, h2 {
            color: #61dafb;
            text-align: center;
        }
        .input-group {
            margin-bottom: 15px;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .input-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #4a4a6b;
            border-radius: 5px;
            background-color: #3b3b5b;
            color: #e0e0e0;
            box-sizing: border-box;
            min-height: 100px;
            font-family: monospace;
            font-size: 0.9em;
        }
        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        button {
            flex-grow: 1;
            padding: 10px;
            background-color: #61dafb;
            color: #1e1e2f;
            border: none;
            border-radius: 5px;
            font-size: 1em;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button.clear-btn {
            background-color: #f44336;
            color: #e0e0e0;
        }
        button.clear-btn:hover {
            background-color: #cc332a;
        }
        button:hover {
            background-color: #4db4d6;
        }
        #analysis-output {
            margin-top: 30px;
            padding: 15px;
            border-top: 2px solid #61dafb;
            background-color: #1e1e2f;
            border-radius: 5px;
        }
        #analysis-output h3 {
            color: #4db4d6;
            margin-top: 0;
            text-align: right;
        }
        .sentiment-bullish { color: #4CAF50; }
        .sentiment-bearish { color: #F44336; }
        .sentiment-neutral { color: #FFEB3B; }
        .error { color: #F44336; font-weight: bold; }

        /* --- سبک‌های موبایل بهینه برای جداول تخصصی --- */
        .table-section {
            margin-bottom: 20px;
            border: 1px solid #3b3b5b;
            border-radius: 5px;
            padding: 10px;
        }
        .table-section h3 {
            color: #e0e0e0;
            border-bottom: 1px dashed #4a4a6b;
            padding-bottom: 5px;
            margin-top: 0;
            text-align: right;
            font-size: 1.1em;
        }
        /* جدول ریسپانسیو برای جداول کوچک */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            direction: ltr;
            font-size: 0.9em;
        }
        .data-table th, .data-table td {
            border: 1px solid #4a4a6b;
            padding: 8px;
            text-align: center;
            white-space: nowrap;
        }
        .data-table th {
            background-color: #3b3b5b;
            color: #61dafb;
        }
        .data-table tr:nth-child(even) {
            background-color: #3b3b5b;
        }
        /* رنگ‌بندی برای داده‌های عددی مهم */
        .data-table td.green { color: #4CAF50; }
        .data-table td.red { color: #F44336; }
        .data-table td.yellow { color: #FFEB3B; }
        .data-table td.blue { color: #61dafb; }
        .data-placeholder { color: #aaa; } /* سبک برای محتوای اولیه */
    </style>
</head>
<body>

<div class="container">
    <h1>تحلیلگر داده‌های فیوچرز کریپتو</h1>
    <p style="text-align: center; color: #aaa;">
        **راهنما:** داده‌ها را از **نماد کوین** تا آخرین ستون (جمعاً **۲۶ ستون**) کپی و جای‌گذاری کنید.
    </p>

    <div class="input-group">
        <label for="rawData">ورودی داده‌ها (هر ستون را با تب یا چند فاصله جدا کنید):</label>
        <textarea id="rawData" placeholder="مثلاً (۲۶ ستون): BTC	45000	+0.5%	+3.5%	+8.2%	45	55	1.2B	+10%	900B	0.01%	15B	+2%	+8%	0.5	+10%	10M	4M	6M	$21.90B	48.43%	$23.33B	51.57%	1.1	1.2	1.3"></textarea>
    </div>

    <div class="button-group">
        <button onclick="analyzeData()">تحلیل داده‌ها</button>
        <button class="clear-btn" onclick="clearForm()">پاک کردن فرم</button>
    </div>

    <div id="data-display-section" style="display: none;">
        <h2>📊 داده‌های استخراج شده (تفکیک شده)</h2>

        <div class="table-section">
            <h3>📈 قیمت، تغییرات و RSI</h3>
            <table class="data-table">
                <thead>
                    <tr><th>پارامتر</th><th>مقدار</th></tr>
                </thead>
                <tbody id="price-table-body"></tbody>
            </table>
        </div>

        <div class="table-section">
            <h3>💰Funding Rate ,Open Interest </h3>
            <table class="data-table">
                <thead>
                    <tr><th>پارامتر</th><th>مقدار</th></tr>
                </thead
                ><tbody id="oi-table-body"></tbody>
            </table>
        </div>

        <div class="table-section">
            <h3>🔥 لیکوئیدیشن‌ها و پوزیشن‌های باز</h3>
            <table class="data-table">
                <thead>
                    <tr><th>پارامتر</th><th>مقدار</th></tr>
                </thead>
                <tbody id="liquidation-table-body"></tbody>
            </table>
        </div>

        <div class="table-section">
            <h3>⚖️ نسبت لانگ/شورت (Long/Short Ratios)</h3>
            <table class="data-table">
                <thead>
                    <tr><th>پارامتر</th><th>مقدار</th></tr>
                </thead>
                <tbody id="ratio-table-body"></tbody>
            </table>
        </div>
    </div>
    
    <div id="analysis-output">
        <h3>خلاصه تحلیل</h3>
        <p class="error" id="error-message" style="display: none;">خطا در پردازش داده‌ها. لطفا مطمئن شوید حداقل **۲۶ ستون** را از **نماد کوین** (Symbol) به بعد وارد کرده‌اید. (تعداد ستون‌های ورودی: <span id="col-count">0</span>)</p>
        <p id="output-oi"></p>
        <p id="output-open-positions"></p>
        <p id="output-liquidation"></p>
        <p id="output-funding"></p>
        <p id="output-rsi"></p>
        <p id="output-conclusion"></p>
    </div>
</div>

<script>
/**
 * تابع کمکی برای پاکسازی و تبدیل رشته‌های داده به عدد.
 */
function cleanAndParse(value) {
    if (typeof value !== 'string') return 0;

    let cleaned = value.replace(/[$,%]/g, '').trim(); 
    const isNegative = value.includes('-');

    let multiplier = 1;
    // مدیریت M, B, T
    if (cleaned.endsWith('T')) { multiplier = 1e12; cleaned = cleaned.slice(0, -1).trim(); }
    else if (cleaned.endsWith('B')) { multiplier = 1e9; cleaned = cleaned.slice(0, -1).trim(); }
    else if (cleaned.endsWith('M')) { multiplier = 1e6; cleaned = cleaned.slice(0, -1).trim(); }

    cleaned = cleaned.replace(/\+/g, '');
    
    let number = parseFloat(cleaned);
    
    if (isNaN(number)) return 0;

    // این تابع عدد نهایی را به شکل "واحد پایه" (مثلاً دلار یا مقدار خام) برمی‌گرداند.
    return isNegative && number > 0 ? -number * multiplier : number * multiplier;
}

/**
 * تابع کمکی برای فرمت دادن به اعداد با رنگ‌بندی.
 */
function formatValue(value, unit = '', precision = 2) {
    const num = typeof value === 'number' && !isNaN(value) ? value : cleanAndParse(value);
    
    let colorClass = 'blue';

    if (unit === '%') {
        colorClass = num > 0 ? 'green' : (num < 0 ? 'red' : 'yellow');
    } else if (unit === 'LS') {
        colorClass = num > 1.05 ? 'green' : (num < 0.95 ? 'red' : 'yellow');
        precision = 3;
    } else if (unit === 'FR') {
        colorClass = num > 0.003 ? 'green' : (num < -0.003 ? 'red' : 'yellow');
        precision = 5;
        unit = '%';
    } else if (unit.includes('M$')) {
        precision = 4;
    } else if (unit === 'RSI') {
        colorClass = num > 65 ? 'red' : (num < 35 ? 'green' : 'yellow'); 
    }

    const formattedNum = num.toFixed(precision);
    return `<td class="${colorClass}">${formattedNum}${unit}</td>`;
}

/**
 * تابع کمکی برای به‌روزرسانی محتوای ستون‌های داده در tbody.
 */
function updateTBody(tbodyId, dataHtmlArray) {
    const tbody = document.getElementById(tbodyId);
    if (!tbody) return;

    const rows = tbody.getElementsByTagName('tr');
    dataHtmlArray.forEach((dataHtml, index) => {
        if (rows[index]) {
            const dataCell = rows[index].getElementsByTagName('td')[0];
            if (dataCell) {
                dataCell.outerHTML = dataHtml; 
            }
        }
    });
}

/**
 * تابع برای ساختاردهی ثابت جداول با استفاده از عناوین جدید.
 */
function initializeTables() {
    // --- ۱. جدول قیمت، تغییرات، RSI، حجم و مارکت کپ ---
    // ترکیب سرفصل‌های مربوط به قیمت و حجم در جدول اول طبق درخواست جدید
    const priceHeaders = [
        'Symbol', 
        'Price', 
        'Price Change (4h)', 
        'Price Change (24h)', 
        'Price Change(7d)',
        'RSI(4 hour)',
        'RSI(1 day)',
        'Volume (24h)', // اضافه شده
        'Volume Change (24h)', // اضافه شده
        'Market Cap' // اضافه شده
    ];
    let priceHtml = '';
    priceHeaders.forEach(header => {
        priceHtml += `<tr><th>${header}</th><td class="data-placeholder">---</td></tr>`;
    });
    document.getElementById('price-table-body').innerHTML = priceHtml;

    // --- ۲. جدول Open Interest و Funding Rate ---
    // حذف ستون‌های Volume از این جدول
    const oiHeaders = [
        'Funding Rate', // اضافه شده
        'OI', 
        'OI Change (4h)', 
        'OI Change (24h)',
        'OI/24h_Vol',
        'OI/24h_Vol (24h%)' 
    ];
    let oiHtml = '';
    oiHeaders.forEach(header => {
        oiHtml += `<tr><th>${header}</th><td class="data-placeholder">---</td></tr>`;
    });
    document.getElementById('oi-table-body').innerHTML = oiHtml;

    // --- ۳. جدول لیکوئیدیشن‌ها ---
    const liquidationHeaders = [
        'Liquidation (24h)', 
        'Long Liquidation (24h)', 
        'Short Liquidation (24h)', 
        'Long (24h) Value', // تغییر نام برای تطابق با درخواست
        'Short (24h) Value'  // تغییر نام برای تطابق با درخواست
    ];
    let liquidationHtml = '';
    liquidationHeaders.forEach(header => {
        liquidationHtml += `<tr><th>${header}</th><td class="data-placeholder">---</td></tr>`;
    });
    document.getElementById('liquidation-table-body').innerHTML = liquidationHtml;

    // --- ۴. نسبت‌های اهرم (L/S Ratio) ---
    // بدون تغییر
    const ratioHeaders = [
        'Bnc L/S Ratio (Accounts)',
        'Bnc Top Trader L/S Ratio (Accounts)',
        'Bnc Top Trader L/S Ratio (Positions)'
    ];
    let ratioHtml = '';
    ratioHeaders.forEach(header => {
        ratioHtml += `<tr><th>${header}</th><td class="data-placeholder">---</td></tr>`;
    });
    document.getElementById('ratio-table-body').innerHTML = ratioHtml;
}

/**
 * پاک کردن ورودی و خروجی‌ها.
 */
function clearForm() {
    document.getElementById('rawData').value = '';
    
    // بازنشانی کامل محتوای تحلیل
    document.getElementById('analysis-output').innerHTML = '<h3>خلاصه تحلیل</h3><p class="error" id="error-message" style="display: none;">خطا در پردازش داده‌ها. لطفا مطمئن شوید حداقل **۲۶ ستون** را از **نماد کوین** (Symbol) به بعد وارد کرده‌اید. (تعداد ستون‌های ورودی: <span id="col-count">0</span>)</p><p id="output-oi"></p><p id="output-open-positions"></p><p id="output-liquidation"></p><p id="output-funding"></p><p id="output-rsi"></p><p id="output-conclusion"></p>';
    
    // بازنشانی محتوای جدول به حالت اولیه (---)
    initializeTables();
    
    // مخفی کردن بخش نمایش داده‌ها
    document.getElementById('data-display-section').style.display = 'none';
    document.getElementById('col-count').textContent = '0';
}

/**
 * تابع اصلی تحلیل داده‌ها.
 */
function analyzeData() {
    // 1. بازنشانی خروجی و پیام خطا
    document.getElementById('analysis-output').innerHTML = '<h3>خلاصه تحلیل</h3><p class="error" id="error-message" style="display: none;">خطا در پردازش داده‌ها. لطفا مطمئن شوید حداقل **۲۶ ستون** را از **نماد کوین** (Symbol) به بعد وارد کرده‌اید. (تعداد ستون‌های ورودی: <span id="col-count">0</span>)</p><p id="output-oi"></p><p id="output-open-positions"></p><p id="output-liquidation"></p><p id="output-funding"></p><p id="output-rsi"></p><p id="output-conclusion"></p>';
    document.getElementById('data-display-section').style.display = 'none';
    
    const rawData = document.getElementById('rawData').value.trim();
    const dataArray = rawData.split(/\s+/).filter(n => n); 
    
    const colCountElement = document.getElementById('col-count');
    if (colCountElement) {
        colCountElement.textContent = dataArray.length;
    }

    const requiredColumns = 26;
    if (dataArray.length < requiredColumns) {
        const errorMessageElement = document.getElementById('error-message');
        if (errorMessageElement) {
             errorMessageElement.style.display = 'block';
        }
        return; 
    }

    let startIndex = Math.max(0, dataArray.length - requiredColumns);

    try {
        // --- ۲. استخراج و آماده‌سازی داده‌ها (این بخش باید ثابت بماند چون به ساختار ورودی وابسته است) ---
        
        // **قیمت و RSI (ستون ۰ تا ۶)**
        const symbol = dataArray[startIndex + 0];             
        const price = dataArray[startIndex + 1];              
        const priceChange4h = cleanAndParse(dataArray[startIndex + 2]);
        const priceChange24h = cleanAndParse(dataArray[startIndex + 3]);
        const priceChange7d = cleanAndParse(dataArray[startIndex + 4]);
        const rsi4h = cleanAndParse(dataArray[startIndex + 5]);        
        const rsi1d = cleanAndParse(dataArray[startIndex + 6]);        
        
        // **حجم، مارکت کپ و OI (ستون ۷ تا ۱۳)**
        const volume24h = dataArray[startIndex + 7];          
        const volumeChange24h = cleanAndParse(dataArray[startIndex + 8]);
        const marketCap = dataArray[startIndex + 9];          
        const fundingRate = cleanAndParse(dataArray[startIndex + 10]);
        const oi = dataArray[startIndex + 11];                
        const oiChange4h = cleanAndParse(dataArray[startIndex + 12]); 
        const oiChange24h = cleanAndParse(dataArray[startIndex + 13]);
        
        // **نسبت OI و لیکوئیدیشن (ستون ۱۴ تا ۱۸)**
        const oiVolRatio = dataArray[startIndex + 14];        
        const oiVolChange = cleanAndParse(dataArray[startIndex + 15]);
        const liquidation24h = cleanAndParse(dataArray[startIndex + 16]);
        const longLiquid = cleanAndParse(dataArray[startIndex + 17]); 
        const shortLiquid = cleanAndParse(dataArray[startIndex + 18]);
        
        // 🌟 داده‌های تفکیک شده لانگ/شورت (ستون ۱۹ تا ۲۲) 🌟
        const longValue = dataArray[startIndex + 19];            
        const longPercent = cleanAndParse(dataArray[startIndex + 20]);
        const shortValue = dataArray[startIndex + 21];           
        const shortPercent = cleanAndParse(dataArray[startIndex + 22]);

        // **نسبت‌های اهرم (ستون ۲۳ تا ۲۵)**
        const binanceLSAcc = cleanAndParse(dataArray[startIndex + 23]); 
        const topTraderLSAcc = cleanAndParse(dataArray[startIndex + 24]);
        const topTraderLS = cleanAndParse(dataArray[startIndex + 25]);


        // --- ۳. به‌روزرسانی محتوای جداول بر اساس ترتیب جدید ---
        
        // ۱. جدول قیمت، تغییرات، RSI، حجم و مارکت کپ
        const priceData = [
            `<td class="blue">${symbol}</td>`,
            `<td class="blue">${price}</td>`,
            formatValue(priceChange4h, '%'),
            formatValue(priceChange24h, '%'),
            formatValue(priceChange7d, '%'),
            formatValue(rsi4h, 'RSI'),
            formatValue(rsi1d, 'RSI'),
            `<td class="blue">${volume24h}</td>`,
            formatValue(volumeChange24h, '%'),
            `<td class="blue">${marketCap}</td>`
        ];
        updateTBody('price-table-body', priceData);

        // ۲. جدول Open Interest و Funding Rate
        const oiData = [
            formatValue(fundingRate, 'FR'),
            `<td class="blue">${oi}</td>`,
            formatValue(oiChange4h, '%'),
            formatValue(oiChange24h, '%'),
            `<td class="yellow">${oiVolRatio}</td>`,
            formatValue(oiVolChange, '%')
        ];
        updateTBody('oi-table-body', oiData);

        // ۳. جدول لیکوئیدیشن‌ها
        const liquidationData = [
            formatValue(liquidation24h / 1e6, 'M$'), 
            formatValue(longLiquid / 1e6, 'M$'), 
            formatValue(shortLiquid / 1e6, 'M$'), 
            `<td class="blue">${longValue} (${longPercent.toFixed(2)}%)</td>`, // ترکیب مقدار و درصد
            `<td class="blue">${shortValue} (${shortPercent.toFixed(2)}%)</td>` // ترکیب مقدار و درصد
        ];
        updateTBody('liquidation-table-body', liquidationData);

        // ۴. نسبت‌های اهرم (L/S Ratio)
        const ratioData = [
            formatValue(binanceLSAcc, 'LS', 3),
            formatValue(topTraderLSAcc, 'LS', 3),
            formatValue(topTraderLS, 'LS', 3)
        ];
        updateTBody('ratio-table-body', ratioData);

        document.getElementById('data-display-section').style.display = 'block';

        // --- ۴. منطق تحلیل و امتیازدهی (این بخش ثابت می‌ماند) ---
        
        let oiAnalysis = '';
        let openPositionsAnalysis = ''; 
        let liquidationAnalysis = '';
        let fundingAnalysis = '';
        let rsiAnalysis = '';
        let finalSentimentText = '';
        let overallSentiment = 0; 
        
        // ۱. تحلیل Open Interest (OI)
        if (oiChange24h > 5 && priceChange24h > 0) {
            oiAnalysis = `<li>**روند صعودی قوی:** افزایش قیمت (+${priceChange24h.toFixed(2)}%) همراه با افزایش OI (+${oiChange24h.toFixed(2)}%) نشان‌دهنده **ورود سرمایه جدید** است.</li>`;
            overallSentiment += 1.0;
        } else if (oiChange24h < -5 && priceChange24h < 0) {
            oiAnalysis = `<li>**روند نزولی قوی:** کاهش قیمت (${priceChange24h.toFixed(2)}%) همراه با کاهش OI (${oiChange24h.toFixed(2)}%) نشان‌دهنده **بستن پوزیشن‌های لانگ در ضرر** است.</li>`;
            overallSentiment -= 0.7;
        } else if (oiChange24h > 5 && priceChange24h < 0) {
            oiAnalysis = `<li>**افزایش شورت‌گیری:** افزایش OI همراه با کاهش قیمت نشان‌دهنده **افزایش فشار فروش (شورت‌گیری) و احتمال Long Squeeze** است.</li>`;
            overallSentiment -= 1.0;
        } else if (oiChange24h < -5 && priceChange24h > 0) {
            oiAnalysis = `<li>**صعود ضعیف (Short Covering):** صعود قیمت همراه با کاهش OI نشان‌دهنده **بستن پوزیشن‌های شورت** و ضعف نسبی در ادامه‌ی روند است.</li>`;
            overallSentiment += 0.3;
        } else {
             oiAnalysis = `<li>**عدم قطعیت/تثبیت:** الگوی OI و قیمت در ۲۴ ساعت گذشته شدید نیست.</li>`;
        }

        // ۲. تحلیل پوزیشن‌های باز لانگ/شورت ۲۴ ساعته 
        const percentDifference = shortPercent - longPercent; 

        if (percentDifference > 3) { 
            openPositionsAnalysis = `<li>**غلبه قوی شورت:** (${shortPercent.toFixed(2)}% شورت در مقابل ${longPercent.toFixed(2)}% لانگ). حجم بالای شورت نشان‌دهنده **ریسک بالا برای Short Squeeze** (فشردگی شورت) در صورت صعود ناگهانی است.</li>`;
            overallSentiment -= 0.3; 
        } else if (percentDifference < -3) { 
            openPositionsAnalysis = `<li>**غلبه قوی لانگ:** (${longPercent.toFixed(2)}% لانگ در مقابل ${shortPercent.toFixed(2)}% شورت). حجم بالای لانگ نشان‌دهنده **ریسک بالا برای Long Squeeze** (فشردگی لانگ) در صورت نزول ناگهانی است.</li>`;
            overallSentiment -= 0.3; 
        } else {
            openPositionsAnalysis = `<li>**تعادل در پوزیشن‌های باز:** لانگ و شورت جدید نسبتاً متعادل هستند.</li>`;
        }
        
        // ۳. تحلیل لیکوئیدیشن و L/S Ratio
        const liquidDifference = (shortLiquid - longLiquid) / 1e6; 
        const shortLiquidM = shortLiquid / 1e6;
        const longLiquidM = longLiquid / 1e6;
        
        if (liquidDifference > 10) { 
            liquidationAnalysis = `<li>**غلبه لیکوئید شورت:** ${shortLiquidM.toFixed(2)}M$ شورت لیکوئید شد (بیش از ۱۰M$ اختلاف). این **فشار صعودی** را تأیید می‌کند.</li>`;
            overallSentiment += 0.5;
        } else if (liquidDifference < -10) {
            liquidationAnalysis = `<li>**غلبه لیکوئید لانگ:** ${longLiquidM.toFixed(2)}M$ لانگ لیکوئید شد (بیش از ۱۰M$ اختلاف). این **فشار نزولی** را تأیید می‌کند.</li>`;
            overallSentiment -= 0.5;
        } else {
            liquidationAnalysis = `<li>**تعادل در لیکوئیدیشن:** لیکوئیدیشن لانگ و شورت نسبتاً برابر است.</li>`;
        }

        if (topTraderLS > 1.25) {
            liquidationAnalysis += `<li>**سنتیمنت قوی لانگ‌گیران برتر:** نسبت L/S پوزیشن تریدرهای برتر (${topTraderLS.toFixed(2)}) **به شدت صعودی** است.</li>`;
            overallSentiment += 1;
        } else if (topTraderLS < 0.75) {
            liquidationAnalysis += `<li>**سنتیمنت قوی شورت‌گیران برتر:** نسبت L/S پوزیشن تریدرهای برتر (${topTraderLS.toFixed(2)}) **به شدت نزولی** است.</li>`;
            overallSentiment -= 1;
        } else {
            liquidationAnalysis += `<li>**سنتیمنت خنثی تریدرهای برتر:** نسبت L/S پوزیشن‌های برتر (${topTraderLS.toFixed(2)}) خنثی است.</li>`;
        }
        
        // ۴. تحلیل Funding Rate
        if (fundingRate > 0.005) {
            fundingAnalysis = `<li>**فاندینگ ریت بالا و مثبت (${fundingRate.toFixed(4)}%):** نشان‌دهنده **احساسات صعودی افراطی (Long Crowding)** است.</li>`;
            overallSentiment += 0.5;
        } else if (fundingRate < -0.005) {
            fundingAnalysis = `<li>**فاندینگ ریت منفی (${fundingRate.toFixed(4)}%):** نشان‌دهنده **احساسات نزولی شدید** است.</li>`;
            overallSentiment -= 0.5;
        } else {
            fundingAnalysis = `<li>**فاندینگ ریت خنثی (${fundingRate.toFixed(4)}%):** فشار شدیدی دیده نمی‌شود.</li>`;
        }

        // ۵. تحلیل RSI
        let rsiClass = 'sentiment-neutral';
        let rsiToAnalyze = rsi4h; 

        if (rsiToAnalyze < 35) {
            rsiAnalysis = `<li>**اشباع فروش (RSI 4h: ${rsiToAnalyze.toFixed(2)}):** سیگنال بالقوه برای **بازگشت صعودی (Reversal)** است.</li>`;
            rsiClass = 'sentiment-bullish'; 
            overallSentiment += 0.3;
        } else if (rsiToAnalyze > 65) {
            rsiAnalysis = `<li>**اشباع خرید (RSI 4h: ${rsiToAnalyze.toFixed(2)}):** سیگنال بالقوه برای **اصلاح یا کاهش قیمت** است.</li>`;
            rsiClass = 'sentiment-bearish'; 
            overallSentiment -= 0.3;
        } else {
            rsiAnalysis = `<li>**خنثی (RSI 4h: ${rsiToAnalyze.toFixed(2)}):** RSI در منطقه خنثی قرار دارد.</li>`;
        }

        // ۶. نتیجه گیری کلی
        let conclusionClass = '';
        
        if (overallSentiment > 1.8) {
            finalSentimentText = 'احساسات کلی بازار **بسیار صعودی و با ریسک عقب‌نشینی بالا** است. باید محتاط بود.';
            conclusionClass = 'sentiment-bullish';
        } else if (overallSentiment > 0.7) {
            finalSentimentText = 'احساسات کلی **صعودی** است. بازار مایل به ادامه رشد است.';
            conclusionClass = 'sentiment-bullish';
        } else if (overallSentiment < -0.7) {
            finalSentimentText = 'احساسات کلی **نزولی** است. قدرت شورت‌گیران بالا است و احتمال کاهش قیمت وجود دارد.';
            conclusionClass = 'sentiment-bearish';
        } else {
            finalSentimentText = 'احساسات کلی **خنثی/نامشخص** است. بهتر است منتظر تأیید بمانید.';
            conclusionClass = 'sentiment-neutral';
        }


        // --- ۵. نمایش خروجی تحلیل ---
        document.getElementById('output-oi').innerHTML = `
            <h3 class="sentiment-neutral">۱. تحلیل Open Interest ,FundingRate 
:</h3>
            <ul>${oiAnalysis}</ul>
        `;
        
        document.getElementById('output-open-positions').innerHTML = `
            <h3 class="sentiment-neutral">۲. تحلیل پوزیشن‌های باز ۲۴ ساعته:</h3>
            <ul>${openPositionsAnalysis}</ul>
        `;

        document.getElementById('output-liquidation').innerHTML = `
            <h3 class="sentiment-neutral">۳. تحلیل لیکوئیدیشن و تریدرهای برتر:</h3>
            <ul>${liquidationAnalysis}</ul>
        `;

        document.getElementById('output-funding').innerHTML = `
            <h3 class="sentiment-neutral">۴. تحلیل Funding Rate:</h3>
            <ul>${fundingAnalysis}</ul>
        `;
        
        document.getElementById('output-rsi').innerHTML = `
            <h3 class="sentiment-neutral">۵. تحلیل شاخص RSI:</h3>
            <ul class="${rsiClass}">${rsiAnalysis}</ul>
        `;
        
        document.getElementById('output-conclusion').innerHTML = `
            <h3 class="sentiment-neutral">نتیجه‌گیری کلی برای ${symbol}:</h3>
            <p class="${conclusionClass}" style="font-size: 1.2em; font-weight: bold;">${finalSentimentText}</p>
        `;

    } catch (e) {
        // در صورت بروز خطای ناشناخته، پیام خطا را نشان دهد
        document.getElementById('error-message').style.display = 'block';
        console.error("An unexpected error occurred:", e);
    }
}

// 🌟 اجرای اولیه تابع ساختاردهی در هنگام بارگذاری صفحه
document.addEventListener('DOMContentLoaded', initializeTables);
</script>

</body>
</html>
